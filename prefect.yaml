# ИСПОЛЬЗОВАТЬ В БУДУЩЕМ YAML ALIASES

name: cyp2d6-nanopore
prefect-version: 3.6.16

# preparation
build:
- prefect.deployments.steps.run_shell_script:
    id: get-commit-hash
    script: git rev-parse --short HEAD
    stream_output: false
- prefect_docker.deployments.steps.build_docker_image:
    id: build-test-image
    requires: prefect-docker>=0.3.1
    image_name: kbaybekov/cyp2d6-test
    tag: "{{ get-commit-hash.stdout }}"
    #tag: 1.0.0
    dockerfile: auto
    nocache: true
    platform: linux/amd64

push:
- prefect_docker.deployments.steps.push_docker_image:
    requires: prefect-docker>=0.3.1
    image_name: '{{ build-test-image.image_name }}'
    tag: '{{ build-test-image.tag }}'

# runtime steps
pull:
  - prefect.deployments.steps.set_working_directory:
      directory: /opt/prefect/copy_number
  - prefect.deployments.steps.git_clone:
      id: clone-step
      repository: https://github.com/KBaybekov/copy_number.git
  #- prefect.deployments.steps.pip_install_requirements:
  #  directory: "{{ clone-step.directory }}"
  #  requirements_file: requirements.txt

# 2. Описываем деплои, ссылаясь на конкретный ID сборки (Этаж 1)
deployments:
  - name: Test-Flow
    version: '{{ build-test-image.tag }}'
    tags: ['test']
    description: "Test flow for checking consistence of Infra"
    schedule: {}
    flow_name: "Test-Flow"
    entrypoint: src/test.py:check_file
    work_pool:
      name: nanopore_docker_pool
      work_queue_name: cpu_nodes
    # Используем результат первой сборки
    job_variables:
      image: "{{ build-test-image.image }}"
