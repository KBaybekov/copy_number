# ИСПОЛЬЗОВАТЬ В БУДУЩЕМ YAML ALIASES

name: cyp2d6-copy
prefect-version: 3.6.16

# preparation
build:
- prefect.deployments.steps.run_shell_script:
    id: get-commit-hash
    script: git rev-parse --short HEAD
    stream_output: false
- prefect_docker.deployments.steps.build_docker_image:
    id: build-image
    requires: prefect-docker>=0.3.1
    image_name: kbaybekov/cyp2d6-copy
    tag: "{{ get-commit-hash.stdout }}"
    dockerfile: auto
    nocache: true
    platform: linux/amd64

push:
- prefect_docker.deployments.steps.push_docker_image:
    requires: prefect-docker>=0.3.1
    image_name: '{{ build-image.image_name }}'
    tag: '{{ build-image.tag }}'

# runtime steps
pull:
  - prefect.deployments.steps.set_working_directory:
      directory: /opt/prefect/
  - prefect.deployments.steps.git_clone:
      id: clone-step
      repository: https://github.com/KBaybekov/copy_number.git
  - prefect.deployments.steps.pip_install_requirements:
      directory: "{{ clone-step.directory }}" # `clone-step` is a user-provided `id` field
      requirements_file: requirements.txt

x-deployment-defaults: &deployment-defaults
  version: '{{ build-image.tag }}'
  schedules: []
  tags: ['nanopore', 'cyp2d6', 'cpu']
  work_pool:
    name: nanopore_docker_pool
    work_queue_name: cpu_nodes
  job_variables:
    image: "{{ build-image.image }}"

# 2. Описываем деплои, ссылаясь на конкретный ID сборки (Этаж 1)
deployments:
  - name: CYP2D6:main_pipeline
    <<: *deployment-defaults 
    description: "Main Flow for processing SVs & CNVs in CYP2D6 gene within ONT data"
    flow_name: "CYP2D6_main_pipeline"
    entrypoint: src/cyp2d6_prefect.py:main_pipeline
    parameters:
      table_input: /mnt/cephfs8_rw/nanopore2/service/code/github/neurology/cyp2d6/copy_number/private/ont_samples.xlsx
      sample_data_csv: /mnt/cephfs8_rw/nanopore2/service/code/github/neurology/cyp2d6/result/CYP2D6_samples.tsv

  - name: CYP2D6:sample_workflow
    <<: *deployment-defaults
    description: "Flow for processing sample"
    flow_name: "CYP2D6_sample_workflow"
    entrypoint: src/core/sample_workflow.py:sample_workflow
    concurrency_limit:
      limit: 50
      collision_strategy: ENQUEUE
      grace_period_seconds: 120 # время, за которое флоу должен развернуться и стартовать


  - name: test_logsss
    <<: *deployment-defaults
    description: "test flow for logs"
    flow_name: "CYP2D6_COPY-Flow"
    entrypoint: src/modules/logger.py:some_flow
